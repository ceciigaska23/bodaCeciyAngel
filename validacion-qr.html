<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validaci√≥n de Asistencia - √Ångel & Ceci</title>

  <!-- Reutilizamos estilos -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="validation-page">
  <div class="validation-container">
    <h2>üé´ Validaci√≥n de Asistencia</h2>
    <div id="validationResult" class="validation-result">
      <p>‚è≥ Validando tu c√≥digo...</p>
    </div>
    <button onclick="window.location.href='/'" class="btn main-btn" style="margin-top: 20px;">
      Volver a la Invitaci√≥n
    </button>
  </div>

  <script>
    // Configuraci√≥n para Vercel - CAMBIA ESTA URL POR TU DOMINIO DE BACKEND DE VERCEL
    const getBackendUrl = () => {
        // Si estamos en localhost, usar el backend local (o el puerto que uses)
        if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
        ) {
            return "http://localhost:3000";
        }
        // Si no, usar la URL de producci√≥n de Vercel
        return "https://boda-cecily-angel-backend.vercel.app";
    };

    const WEDDING_BACKEND_URL = getBackendUrl();

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const resultDiv = document.getElementById("validationResult");

      if (!code) {
        resultDiv.innerHTML = `<p class="error">‚ùå No se proporcion√≥ un c√≥digo de confirmaci√≥n.</p>`;
        return;
      }

      try {
        // üîó Llama a tu backend, que a su vez valida con Google Apps Script
        const response = await fetch(`${WEDDING_BACKEND_URL}/api/validate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });

        const data = await response.json();
        
        // El Apps Script ahora devuelve "success" y un mensaje.
        if (data.success) {
          resultDiv.innerHTML = `
            <p class="success">‚úÖ Asistencia confirmada</p>
            <p><strong>¬°Bienvenido(a), ${data.guestName}!</strong></p>
            <p class="small-text">${data.message}</p>
          `;
        } else {
          resultDiv.innerHTML = `
            <p class="error">‚ùå C√≥digo inv√°lido o ya utilizado</p>
            <p>${data.message || 'Verifica con los novios'}</p>
          `;
        }
      } catch (error) {
        console.error("Error al validar:", error);
        resultDiv.innerHTML = `<p class="error">‚ùå Error al validar. Por favor, intenta de nuevo.</p>`;
      }
    });
  </script>
</body>
</html>
